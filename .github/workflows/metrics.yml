name: Record clone metrics

on:
  workflow_call:
    inputs:
      observed-repo:
        description: "Repository to fetch clone metrics from (OWNER/REPO)"
        required: false
        default: ${{ github.repository }}
        type: string
      metrics-repo:
        description: "Target repo for storing metrics (OWNER/REPO)"
        required: true
        type: string
    secrets:
      METRICS_PAT:
        required: true

permissions:
  contents: read

jobs:
  record:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch clone stats
        env:
          GH_TOKEN: ${{ secrets.METRICS_PAT }}
          OBSERVED_REPO: ${{ inputs.observed-repo }}
        run: |
          curl -s \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/$OBSERVED_REPO/traffic/clones \
            > clones.json

          CLONES=$(jq -r '.count // 0' clones.json)
          UNIQUES=$(jq -r '.uniques // 0' clones.json)

          echo "CLONES=$CLONES" >> $GITHUB_ENV
          echo "UNIQUES=$UNIQUES" >> $GITHUB_ENV

      - name: Debug auth identity
        env:
          GH_TOKEN: ${{ secrets.METRICS_PAT }}
        run: |
          curl -s \
            -H "Authorization: Bearer $GH_TOKEN" \
            https://api.github.com/user | jq '{login, id}'

      - name: Debug repo access
        env:
          GH_TOKEN: ${{ secrets.METRICS_PAT }}
          OBSERVED_REPO: ${{ inputs.observed-repo }}
        run: |
          curl -s \
            -H "Authorization: Bearer $GH_TOKEN" \
            https://api.github.com/repos/$OBSERVED_REPO | jq '{full_name, private}'

      - name: Debug clone API
        run: |
          echo "===== clones.json ====="
          cat clones.json
          echo "======================"

      - name: Append to metrics repo
        run: |
          git clone https://x-access-token:${{ secrets.METRICS_PAT }}@github.com/${{ inputs.metrics-repo }}.git metrics-temp
          cd metrics-temp

          git config user.name "metrics-bot"
          git config user.email "metrics-bot@users.noreply.github.com"

          DATE=$(date +%F)
          FILE="data/$(echo '${{ github.repository }}' | tr '/' '__').csv"

          mkdir -p data
          if [ ! -f "$FILE" ]; then
            echo "date,repository,clones,uniques" > "$FILE"
          fi

          # Remove today's entry if it exists
          grep -v "^$DATE," "$FILE" > "$FILE.tmp" || true
          mv "$FILE.tmp" "$FILE"

          # Append new line
          echo "$DATE,${{ github.repository }},$CLONES,$UNIQUES" >> "$FILE"

          git add "$FILE"
          git commit -m "metrics: record clone stats for ${{ github.repository }}" || true
          git push
