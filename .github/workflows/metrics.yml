name: Record clone metrics

on:
  workflow_call:
    inputs:
      observed-repo:
        description: "Repository to fetch clone metrics from (OWNER/REPO)"
        required: false
        default: ${{ github.repository }}
        type: string
      metrics-repo:
        description: "Target repo for storing metrics (OWNER/REPO)"
        required: true
        type: string
    secrets:
      METRICS_PAT:
        required: true

permissions:
  contents: read

jobs:
  record:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch clone stats
        env:
          GH_TOKEN: ${{ secrets.METRICS_PAT }}
          OBSERVED_REPO: ${{ inputs.observed-repo }}
        run: |
          curl -L \
            -D headers.txt \
            -o clones.json \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/$OBSERVED_REPO/traffic/clones

          CLONES=$(jq -r '.count // 0' clones.json)
          UNIQUES=$(jq -r '.uniques // 0' clones.json)

          echo "CLONES=$CLONES" >> $GITHUB_ENV
          echo "UNIQUES=$UNIQUES" >> $GITHUB_ENV

      - name: Debug auth identity
        env:
          GH_TOKEN: ${{ secrets.METRICS_PAT }}
        run: |
          curl -s \
            -H "Authorization: Bearer $GH_TOKEN" \
            https://api.github.com/user | jq '{login, id}'

      - name: Debug repo access
        env:
          GH_TOKEN: ${{ secrets.METRICS_PAT }}
          OBSERVED_REPO: ${{ inputs.observed-repo }}
        run: |
          curl -s \
            -H "Authorization: Bearer $GH_TOKEN" \
            https://api.github.com/repos/$OBSERVED_REPO | jq '{full_name, private}'

      - name: Debug clone API
        run: |
          echo "===== clones.json ====="
          cat clones.json
          echo "======================"

      - name: Append/update metrics CSV in metrics repo
        run: |
          git clone https://x-access-token:${{ secrets.METRICS_PAT }}@github.com/${{ inputs.metrics-repo }}.git metrics-temp
          cd metrics-temp

          git config user.name "metrics-bot"
          git config user.email "metrics-bot@users.noreply.github.com"

          FILE="data/$(echo '${{ github.repository }}' | tr '/' '__').csv"
          mkdir -p data

          # Create header if the file doesn't exist
          if [ ! -f "$FILE" ]; then
            echo "date,repository,clones,uniques" > "$FILE"
          fi

          TMPFILE="$FILE.tmp"
          cp "$FILE" "$TMPFILE"

          # Append/update all daily lines from clones.json
          jq -r --arg REPO "${{ github.repository }}" \
            '.clones[] | [.timestamp[0:10], $REPO, .count, .uniques] | @csv' ../clones.json | while read LINE; do
              DATE=$(echo "$LINE" | cut -d',' -f1)
              # Remove any existing line for this date + repo
              grep -v "^$DATE,${{ github.repository }}," "$TMPFILE" > "$TMPFILE.new" || true
              mv "$TMPFILE.new" "$TMPFILE"
              # Append the new line
              echo "$LINE" >> "$TMPFILE"
          done

          # Append/update the 14-day totals line
          # Compute the totals line with today’s date
          TODAY=$(date +%F)
          REPO="${{ github.repository }}"
          TOTAL_LINE=$(jq -r --arg REPO "${{ github.repository }}" \
            --arg DATE "$TODAY" \
            '[ "\($DATE) 14-day total", $REPO, .count, .uniques ] | @csv' ../clones.json)

          # Remove any existing line for today’s 14-day total
          # Remove old 14-day total line if it exists
          if [ -f "$FILE" ]; then
            grep -v "^$TODAY 14-day total,$REPO," "$FILE" > "$FILE.tmp" || true
            mv "$FILE.tmp" "$FILE"
          fi

          # Append the new totals line
          echo "$TOTAL_LINE" >> "$FILE"

          # Replace original CSV with updated CSV
          mv "$TMPFILE" "$FILE"

          git add "$FILE"
          git commit -m "metrics: record clone stats for ${{ github.repository }}" || true
          git push

